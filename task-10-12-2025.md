# Backend Architecture Blueprint & Development Roadmap

**Date:** 10 December 2025  
**Target:** Microservice-Ready Backend (Gojek-like Super App)  
**Focus:** Strict Separation of Concerns, Scalability, and Region-based Availability.

---

## 1. Architectural Principles

### 1.1. Strict Module Decoupling

-   **Rule:** Modules **MUST NOT** depend on each other directly (e.g., `Product` cannot use `Region` classes directly).
-   **Communication:** All inter-module interaction must go through `App\Shared` Interfaces or Domain Events.
-   **Database:** Each module owns its tables. No cross-module joins allowed.

### 1.2. Command Query Responsibility Segregation (CQRS) - Simplified

-   **Merchant Endpoint (Write Model):** Direct access to SQL Database via respective modules (Product, Inventory) to ensure **Strong Consistency**. Merchants must see real-time data when editing.
-   **User Endpoint (Read Model):** Access via **Catalog Module** (Elasticsearch). Accepts **Eventual Consistency** for extreme search speed and aggregation.

### 1.3. Promotion Ownership (Merchant vs Provider)

-   **Merchant Promo:** Created by merchant, cost borne by merchant (cuts their revenue).
-   **Provider Promo:** Created by App Admin, cost borne by platform (Marketing Burn Rate).
-   **Calculation:** The system must track the _source_ of the discount for financial reconciliation.

---

## 2. Module Responsibilities & Boundary

### A. Module Product ("The Catalog Source")

-   **Responsibility:** Master data management of physical/digital items.
-   **Scope:** Name, Description, Images, SKU, Dimensions, Weight, **Base Price**.
-   **Explicitly Excluded:** Tax calculation, Discount logic, Inventory count, Availability logic.
-   **Key Change:** Add `tax_group_id` to group products for tax rules (e.g., "Food", "Service", "Goods").

### B. Module Region ("The Territory Engine")

-   **Responsibility:** Spatial availability and regional configuration.
-   **Core Logic:** Point-in-Polygon algorithm to determine if a user/merchant is inside a valid region.
-   **Configuration:** Links specific Services (Ride, Food, Mart) to Regions.
-   **Integration:** Provides `RegionID` based on Coordinates.

### C. Module Tax ("The Finance Engine")

-   **Responsibility:** Dynamic tax calculation based on Region and Product Category.
-   **Logic:** `TaxRule` matches `RegionID` + `ProductCategoryID` -> Returns Tax Rate (e.g., PB1 10%, PPN 11%).

### D. Module Promotion ("The Marketing Engine")

-   **Responsibility:** Discount and Campaign management.
-   **Ownership Flag:** `creator_type` ('merchant' | 'provider').
-   **Schemes:**
    1.  **Product Discount:** Strikethrough price (Coret Harga).
    2.  **Cart Voucher:** Deduct total bill (Min purchase requirement).
    3.  **Delivery Discount:** Deduct shipping cost.

### E. Module Catalog ("The Search Engine")

-   **Responsibility:** Aggregating data for User-facing APIs.
-   **Technology:** Elasticsearch.
-   **Data Structure:** Flattened Document containing:
    -   Product Data (from Product Module)
    -   Calculated Price (Base + Tax - Product Discount)
    -   Availability (from Inventory & Region)
    -   Geo Location (Merchant Coordinate)

---

## 3. Implementation Roadmap (Phasing)

### Phase 1: Infrastructure & Territory

**Goal:** Define "Where" and "How much (Currency/Tax)" rules apply.

1.  **Module Region**:
    -   Migration: `regions` (id, name, polygon_geometry, timezone, currency_code).
    -   Migration: `region_services` (region_id, service_name, is_active).
    -   Service: `RegionService` with method `getRegionByCoordinates(lat, lng)`.
2.  **Module Setting (Refactor)**:
    -   Migration: `currencies` (code, symbol, exchange_rate).
    -   Logic: Bind Currency to Region (One Region has One Default Currency).
3.  **Module Tax**:
    -   Migration: `tax_rules` (name, rate, type, region_id, category_id).
    -   Service: `TaxCalculator` implementing `calculate(price, regionId, categoryId)`.

### Phase 2: Product Module Purification

**Goal:** Clean up Product Module to be a pure data source.

1.  **Refactoring**:
    -   Remove `calculateProductPrice`, `getDummyPromoData`, `getDummyInventoryData` from `ProductService`.
    -   Remove tax/discount validation logic.
2.  **Enhancement**:
    -   Add `tax_group_id` column to `products`.
    -   Ensure `ProductService` integrates with `Shared\RegionService` to validate Merchant's location eligibility during creation.

### Phase 3: Promotion Engine Implementation

**Goal:** Flexible promo engine with clear ownership tracking.

1.  **Database**:
    -   `promotions`: (id, name, type, **creator_type**, **merchant_id** (nullable), start_date, end_date).
    -   `promotion_rules`: (promo_id, rule_type, rule_value).
    -   `promotion_benefits`: (promo_id, benefit_type, value, max_amount).
2.  **Logic**:
    -   `MerchantPromoService`: Handles creation of promos by merchants (scope restricted to their products).
    -   `ProviderPromoService`: Handles creation of global/regional promos by admin.
    -   `DiscountCalculator`: Accepts Cart + User Info, returns `FinalTotal` and `DiscountBreakdown` (Merchant portion vs Provider portion).

### Phase 4: Catalog & Elasticsearch Integration

**Goal:** High-performance Read API for Users.

1.  **Setup**: Configure Elasticsearch Client in `Modules/Catalog`.
2.  **Indexer Service**:
    -   Construct the "Golden Record": Product + Active Product Discount + Tax Rate + Merchant Location.
3.  **Event Driven Sync**:
    -   Listener: `ProductPriceChanged`, `ProductUpdated`, `PromoStarted`, `TaxRuleUpdated`.
    -   Action: Re-index relevant documents in Elasticsearch.
4.  **Search Service**:
    -   Implement Geo-spatial search (find "Nasi Goreng" within 5km radius).

### Phase 5: Merchant Availability & Verification

**Goal:** Ensure merchants comply with Regional rules.

1.  **Merchant Module**:
    -   Link Merchant Profile to `Region`.
    -   Middleware: Block access/visibility if Merchant's Region has disabled the specific service (e.g., "Food" service disabled in "Bali" region temporarily).

---

## 4. Technical Notes for Continuation

-   **Shared Interfaces:** Always verify `app/Shared` interfaces before implementing service logic.
-   **i18n:** Use translation keys (`module::file.key`) for all user-facing errors.
-   **Testing:** Create Feature Tests for the "Happy Path" of a Merchant registering -> Creating Product -> Product appearing in Catalog (mocked ES).
